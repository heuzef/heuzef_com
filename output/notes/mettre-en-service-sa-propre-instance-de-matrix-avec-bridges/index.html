<!doctype html>
<html lang="fr">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Heuzef</title>
  <link rel="canonical" href="https://heuzef.com/notes/mettre-en-service-sa-propre-instance-de-matrix-avec-bridges/index.html">

    <link rel="apple-touch-icon" href="https://heuzef.com/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" href="https://heuzef.com/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://heuzef.com/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="https://heuzef.com/manifest.json">
    <meta name="theme-color" content="#333333">

  <link rel="stylesheet" href="https://heuzef.com/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://heuzef.com/theme/css/fontawesome.min.css">
  <link rel="stylesheet" href="https://heuzef.com/theme/css/pygments/manni.min.css">
  <link rel="stylesheet" href="https://heuzef.com/theme/css/theme.css">

  <link rel="alternate" type="application/atom+xml" title="Full Atom Feed"
        href="https://heuzef.com/feeds/all.atom.xml">
  <link rel="alternate" type="application/atom+xml" title="Categories Atom Feed"
        href="https://heuzef.com/feeds/informatique.atom.xml">  
  <meta name="description" content="Pour ceux qui ne connaissent pas Matrix, je le prÃ©sente succinctement ainsi : câ€™est un outil messagerie moderne, qui est supÃ©rieure techniquement Ã  toutes les autres solutions Ã©quivalentes (Instagram, WhatsApp, Messenger, Signal, WeChat, Telegram, Discord, etc â€¦). Mais ce nâ€™est pas tout, en plus dâ€™Ãªtre trÃ¨s sÃ©curisÃ©, câ€™est â€¦">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
    <div class="col-sm-4">
      <a href="https://heuzef.com/">
        <img class="img-fluid rounded" src=https://heuzef.com/assets/logo_heuzef_hd.png alt="Heuze Florent">
      </a>
    </div>
  <div class="col-sm-8">
    <h1 class="title"><a href="https://heuzef.com/">Heuze Florent</a></h1>
      <p class="text-muted">
Les notes excentriques d'un bidouilleur.
</p>
      <ul class="list-inline">
          <li class="list-inline-item"><a href="https://cv.heuzef.com" target="_blank"><i class="fa fa-file"></i> mon cv</a></li>
              <li class="list-inline-item text-muted">|</li>
            <li class="list-inline-item"><a href="https://heuzef.com/contact.html">Contact</a></li>
            <li class=" list-inline-item text-muted">|</li>
          <li class="list-inline-item"><a class="fab fa-linkedin" href="https://www.linkedin.com/in/heuzef/" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fab fa-git" href="https://github.com/heuzef" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fas fa-heartbeat" href="https://status.heuzef.com" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fas fa-map" href="https://network.heuzef.com" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fas fa-rss" href="https://heuzef.com/feeds/all.atom.xml" target="_blank"></a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  Mettre en service sa propre instance de Matrix avec&nbsp;Bridges
</h1>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2024-04-08T00:00:00+02:00">
          <i class="fas fa-clock"></i>
          Mon 08 April 2024
        </li>
        <li class="list-inline-item">
          <i class="fas fa-folder-open"></i>
          <a href="https://heuzef.com/category/informatique/">Informatique</a>
        </li>
          <li class="list-inline-item">
            <i class="fas fa-tag"></i>
              <a href="https://heuzef.com/tag/autohebergement/">#autohÃ©bergement</a>,               <a href="https://heuzef.com/tag/web/">#web</a>,               <a href="https://heuzef.com/tag/social/">#social</a>,               <a href="https://heuzef.com/tag/docker/">#docker</a>,               <a href="https://heuzef.com/tag/tchat/">#tchat</a>,               <a href="https://heuzef.com/tag/communication/">#communication</a>          </li>
      </ul>
    </header>
    <div class="content">
      <p>Pour ceux qui ne connaissent pas Matrix, je le prÃ©sente succinctement ainsi : câ€™est un outil messagerie moderne, qui est supÃ©rieure techniquement Ã  toutes les autres solutions Ã©quivalentes (Instagram, WhatsApp, Messenger, Signal, WeChat, Telegram, Discord, etcÂ â€¦). </p>
<p>Mais ce nâ€™est pas tout, en plus dâ€™Ãªtre trÃ¨s sÃ©curisÃ©, câ€™est aussi une solution libre, Ã©thique et dÃ©centralisÃ©e et en constante Ã©volution grÃ¢ce Ã  une large communautÃ© trÃ¨s impliquÃ©e dans cette solution de messagerie ultime enÂ auto-hÃ©bergement.</p>
<p>Il nâ€™y a donc absolument aucun argument en faveur des autres plateformes (mÃªme pour Signal et RocketChat oui oui) et dans un monde idÃ©al lâ€™humanitÃ© entiÃ¨re utiliserais Matrix comme solution unique deÂ communication.</p>
<p>Jâ€™ajoute que tout bon dirigeant dâ€™entreprise qui utilise une solution de tchat en interne devrait dÃ©ployer Matrix pour sa sociÃ©tÃ©, tout autre choix sera finalement moins pertinent, voir dangereux. Le monopÃ´le de Microsoft avec Teams nâ€™est dâ€™ailleurs pas un frein, car il est tout Ã  fait possible dâ€™intÃ©grer des solutions de Visio comme <a href="https://meet.jit.si">Jitsi</a> dans lâ€™instance Matrix. Et une fois que nous avons goÃ»tÃ© Ã  lâ€™outil, nous sommes rapidementÂ convaincus.</p>
<p><img alt="Messenger FR" class="img-fluid" src="../../assets/messenger_fr.png"/></p>
<p>Maintenant que les prÃ©sentations sont faites, je vais expliquer dans cette note comment dÃ©ployer simplement une instance avec Docker et surtout avec desÂ Bridges.</p>
<p>Je prÃ©cise que cette note est co-rÃ©digÃ©e avec <a href="https://www.linkedin.com/in/lucasassier">Lucas Assier</a>, qui Ã  Ã©galement une expÃ©rience intÃ©rÃ©ssente avec Matrix de son cÃ´tÃ©Â !</p>
<p>Avant de dÃ©buter lâ€™aventure, <a href="https://app.element.io/#/register">commencez par crÃ©er un compte Matrix</a>. RÃ©server votre identifiant et profitez-en pour tester Matrix sur les serveursÂ dâ€™Ã‰lement.</p>
<h1>Qui utilise Matrix en 2024 ?Â ğŸ—£</h1>
<p>Quasiment personne, comme beaucoup dâ€™outils libre, pas de gros marketing derriÃ¨re. MÃªme <a href="https://www.signal.org">Signal</a>, qui met pourtant les moyens, peine Ã  concurrencer ses concurrents qui sont pourtant pas terribles, alors autant dire que Matrix nâ€™est pas prÃªt de percer, mais patience, car contrairement aux autres, Matrix est pÃ©renne dans le temps et sera lÃ  encore bien aprÃ¨s eux (lâ€™e-mail, xmpp et irc enÂ tÃ©moignent).</p>
<p>Finalement, les seuls qui ont un intÃ©rÃªt Ã  dÃ©ployer Matrix, sont les entreprises, associations et organisations qui souhaitent disposer dâ€™un outil de communication en interne. Pour les autres, on y retrouvera majoritairement des Geek qui ont la chance dâ€™avoir les ressources et le temps pour maintenir cetÂ outil.</p>
<h1>Les Bridges !Â ğŸ—</h1>
<p>En plus de pouvoir <a href="https://matrix.org/ecosystem/clients/">choisir nâ€™importe quel client</a> (ce qui est dÃ©jÃ  gÃ©nial), Matrix a une fonction vraiment top : <strong>Les bridges</strong>Â !</p>
<p>Elle vous promet de rÃ©cupÃ©rer vos messages des autres plateformes dans votre instance MatrixÂ !</p>
<p><a href="https://matrix.org/ecosystem/bridges"><i class="fa fa-link"></i>Â matrix.org/ecosystem/bridges</a></p>
<p>Il faut comprendre que les Bridges sont additionnels et heureusement, car il y a baleine sous gravillon, explication dans le chapitreÂ suivant.</p>
<h1>Le piÃ¨ge des BridgesÂ ğŸš§</h1>
<p>AprÃ¨s plusieurs mois dâ€™utilisation des Bridges, je vais Ãªtre honnÃªte, câ€™est un calvaire et la maintenance est chronophage au possible. Les Bridges sont essentiellement des prototypes et plus nous en ajoutons plus câ€™est le chaos : la maintenance nâ€™en devient que plusÂ lourde.</p>
<p>Chaque Bridge Ã  son lot de galÃ¨re, câ€™est sans fin, <strong>il faut donc Ãªtre dÃ©terminÃ© Ã  y consacrer beaucoup de tempsÂ !</strong></p>
<p>Autrement, la meilleure alternative que je connaisse est <a href="https://ems.element.io/element-one">Element-<span class="caps">ONE</span></a>, payant et avec seulement trois Bridges, mais câ€™est un dÃ©butÂ ğŸ˜‰</p>
<h1>DÃ©ploiement basique avec DockerÂ ğŸ³</h1>
<p>Si vous Ãªtes Ã  lâ€™aise avec Docker, alors la configuration suivante vous permettra de mettre en place votre instance Matrix. Pour les plus barbus, vous pouvez aussi <a href="https://github.com/spantaleev/matrix-docker-ansible-deploy">jouer avec Ansible</a>Â ğŸ¤“</p>
<p>La configuration gÃ©nÃ©rale ici est donc dâ€™installer le moteur Synapse avec sa <span class="caps">DB</span> Postgres. Avec seulement ceci, vous pourrez bÃ©nÃ©ficier dâ€™une instance Matrix qui tourne trÃ¨sÂ bien.</p>
<p>Pour tout le reste, ce sont les Bridges, que vous pouvez simplement commenter pour ne pas les dÃ©ployer dans un premier temps, (ou jamais ?Â ğŸ˜¤)</p>
<h2>Docker composeÂ file</h2>
<div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3'</span>

<span class="nt">services</span><span class="p">:</span>

<span class="w">  </span><span class="c1"># Synapse</span>
<span class="w">  </span><span class="nt">synapse</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrixdotorg/synapse:latest</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-synapse</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-synapse</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SYNAPSE_CONFIG_PATH=/data/homeserver.yaml</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/Synapse:/data</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/bridges:/bridges</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/test:/var/log</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-db</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8448:8448/tcp</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008:8008/tcp</span>

<span class="w">  </span><span class="nt">matrix-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-db</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-db</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=synapse</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=**********</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRESQL_PASSWORD=**********</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=matrix</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/Postgres:/var/lib/postgresql/data</span>

<span class="c1"># BRIDGES CONTAINERS ##########</span>

<span class="w">  </span><span class="c1"># Signal bridge</span>
<span class="w">  </span><span class="nt">mautrix-signal</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dock.mau.dev/mautrix/signal</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-signal</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-signal</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/bridges/signal/signald:/signald</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/bridges/signal/data:/data</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">29328:29328/tcp</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">signald</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">signal-db</span>

<span class="w">  </span><span class="nt">signald</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/signald/signald</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">signald</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">signald</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/bridges/signal/signald:/signald</span>

<span class="w">  </span><span class="nt">signal-db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">signal-db</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">signal-db</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=mautrixsignal</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DATABASE=mautrixsignal</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=**********</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/bridges/signal/Postgres:/var/lib/postgresql/data</span>

<span class="w">  </span><span class="c1"># Discord bridge</span>
<span class="w">  </span><span class="nt">mautrix-discord</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dock.mau.dev/mautrix/discord</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-discord</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-discord</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/bridges/discord/data:/data</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">29334:29334/tcp</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse</span>

<span class="w">  </span><span class="c1"># Whatsapp bridge</span>
<span class="w">  </span><span class="nt">mautrix-whatsapp</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dock.mau.dev/mautrix/whatsapp</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-whatsapp</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-whatsapp</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/bridges/whatsapp/data:/data</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">29318:29318/tcp</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse</span>

<span class="w">  </span><span class="c1"># Facebook bridge</span>
<span class="w">  </span><span class="nt">mautrix-facebook</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dock.mau.dev/mautrix/facebook</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-facebook</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-facebook</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/bridges/facebook/data:/data</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">29319:29319/tcp</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse</span>

<span class="w">  </span><span class="c1"># Instagram bridge</span>
<span class="w">  </span><span class="nt">mautrix-instagram</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dock.mau.dev/mautrix/instagram</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-instragram</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-instagram</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/bridges/instagram/data:/data</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">29330:29330/tcp</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse</span>

<span class="w">  </span><span class="c1"># Telegram bridge</span>
<span class="w">  </span><span class="nt">mautrix-telegram</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dock.mau.dev/mautrix/telegram</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-telegram</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-telegram</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/bridges/telegram/data:/data</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">29317:29317/tcp</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse</span>

<span class="c1"># Slack bridge</span>
<span class="nt">mautrix-slack</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dock.mau.dev/mautrix/slack</span>
<span class="w">  </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-slack</span>
<span class="w">  </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-slack</span>
<span class="w">  </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/matrix/bridges/slack/data:/data</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">29335:29335/tcp</span>
<span class="w w-Error"> </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse</span>

<span class="c1"># Wechat bridge </span>
<span class="nt">matrix-wechat</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lxduo/matrix-wechat</span>
<span class="w">  </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-wechat</span>
<span class="w">  </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-wechat</span>
<span class="w">  </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/heuzef/matrix/bridges/wechat/data:/data</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">17778:17778/tcp</span>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse</span>

<span class="c1"># Wechat agent</span>
<span class="nt">agent-wechat</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lxduo/matrix-wechat-docker</span>
<span class="w">  </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">agent-wechat</span>
<span class="w">  </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">agent-wechat</span>
<span class="w">  </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">  </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WECHAT_HOST=wss://matrix-wechat/_wechat/</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WECHAT_SECRET=00000000000</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/heuzef/matrix/bridges/wechat/hongli/:/home/user/matrix-wechat-agent</span>
<span class="w">  </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-wechat</span>
</code></pre></div>
<h2>Configuration deÂ Synapse</h2>
<p>GÃ©nÃ©rer le fichier de config SynapseÂ : </p>
<div class="highlight"><pre><span></span><code>docker run -it --rm -v /home/matrix/Synapse/:/data -e SYNAPSE_SERVER_NAME=matrix.domain.tld -e SYNAPSE_REPORT_STATS=no matrixdotorg/synapse:latest generate
</code></pre></div>
<p>Ce fichier de configuration sera gÃ©nÃ©rÃ© dans  <strong>/home/matrix/Synapse/homeserver.yaml</strong>, plutÃ´t simple Ã  comprendre, voici quelques paramÃ¨tres Ã  modifier selon vos besoinsÂ :</p>
<div class="highlight"><pre><span></span><code><span class="nt">max_upload_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100M</span>
<span class="nt">enable_registration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">enable_registration_without_verification</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">app_service_config_files</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bridges/discord/data/registration.yaml</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bridges/facebook/data/registration.yaml</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bridges/instagram/data/registration.yaml</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bridges/signal/data/registration.yaml</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bridges/slack/data/registration.yaml</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bridges/telegram/data/registration.yaml</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bridges/wechat/data/registration.yaml</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bridges/whatsapp/data/registration.yaml</span>
</code></pre></div>
<p>Chaque fichier de configuration des bridges est similaire, les paramÃ¨tres rÃ©currents Ã  modifier sont les suivantsÂ :</p>
<div class="highlight"><pre><span></span><code><span class="nt">homeserver</span><span class="p">:</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://matrix.domain.tld</span>
<span class="w">    </span><span class="nt">domain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix.domain.tld</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://&lt;hostname&gt;:&lt;port&gt;</span>
<span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;port&gt;</span>
<span class="w">    </span><span class="nt">database</span><span class="p">:</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sqlite3</span>
<span class="w">        </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;bridge&gt;-db.sqlite</span>
<span class="w">    </span><span class="nt">permissions</span><span class="p">:</span>
<span class="w">        </span><span class="s">"*"</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">relay</span>
<span class="w">        </span><span class="s">"matrix.domain.tld"</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user</span>
<span class="w">        </span><span class="s">"@votre-pseudo:matrix.domain.tld"</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
</code></pre></div>
<p>Maintenant, vous pouvez dÃ©marrer toute la tambouille : <code>docker compose -f /home/matrix/docker-compose.yml up</code></p>
<p>Le premier lancement prend du temps, les fichiers de configuration et de <strong>registration.yaml</strong> doivent Ãªtre gÃ©nÃ©rÃ©s par Synapse (nâ€™anticipez pas leur crÃ©ation), confirmant que tout fonctionne correctement, ensuite, vous pouvez Ã©diter lesÂ paramÃ¨tres.</p>
<p>Vous aurez probablement une erreur de permission sur ces fichiers au lancement, ajustez simplement cela ainsiÂ :</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">644</span><span class="w"> </span>/home/matrix/bridges/*/data/registration.yaml
</code></pre></div>
<h2>VisioconfÃ©rence</h2>
<p>Si vous souhaitez utiliser la visioconfÃ©rence, notez bien que cette derniÃ¨re ne fonctionnera quâ€™en local sur votre rÃ©seau interne. Pour aller plus loin et profiter pleinement des fonctionnalitÃ©s de la visioconfÃ©rence, il vous faudra mettre en service un serveur <span class="caps">TURN</span> : <a href="https://matrix-org.github.io/synapse/latest/turn-howto.html">Configuring a Turn Server -Â Synapse</a></p>
<h1>Mon retour dâ€™expÃ©rience sur les diffÃ©rents BridgesÂ ğŸ“¢</h1>
<p>Vous remarquerez que la plupart des Bridges sont dÃ©ployÃ©es via <a href="https://docs.mau.fi/bridges/general/docker-setup.html?bridge=telegram&amp;ref=infos.zogg.fr"><span class="caps">MAUTRIX</span></a>. Ce nâ€™est pas pour rien, car la plus grande panoplie est Ã©ditÃ©e par eux et ce sont aussi bien souvent les bridges les plusÂ stables.</p>
<p>Pour rappel <a href="https://matrix.org/ecosystem/bridges/">la liste des Bridges est diffusÃ©e sur le site officiel de Matrix</a>.</p>
<p>De faÃ§on gÃ©nÃ©rale, la logique dâ€™ajout dâ€™un bridge est toujours la mÃªmeÂ :</p>
<ol>
<li>
<p>ExÃ©cution duÂ bridge</p>
</li>
<li>
<p>Depuis votre client Matrix prÃ©fÃ©rÃ©, rechercher le bot du bridge pour commencer une discussion avecÂ lui</p>
</li>
<li>
<p>Dans le canal de discussion avec le bot taper <code>help</code> pour afficher les actionsÂ possibles</p>
</li>
</ol>
<h2>Signal</h2>
<p>Le Bridge de Signal est un peu lourd Ã  mettre en place, car il rÃ©clame une <span class="caps">DB</span> Ã  part (ce que je vous conseille vivement de faire pour lesÂ performances).</p>
<ol>
<li>InviterÂ @signalbot</li>
<li>Enregistrez votre tÃ©lÃ©phone <code>register +33000000000</code></li>
<li>RÃ©cupÃ©rer un jeton captcha sur le site dÃ©diÃ© deÂ signal</li>
<li>https://signalcaptchas.org/registration/generate.html</li>
<li>RÃ©cupÃ©rer le token situÃ© juste aprÃ¨s le <strong>signalcaptcha://signal-recaptcha-v2.</strong></li>
<li>Valider le code <span class="caps">SMS</span></li>
<li>DÃ©finir son nom : <code>set-profile-name VOTRE-NOM</code></li>
</ol>
<h2>Discord</h2>
<p>Pour Discord, la premiÃ¨re initialisation ne permet que de jongler avec les messageries privÃ©es, vous aurez ensuite besoin de jouer avec les commandes du bridges pour rejoindre les diffÃ©rents canaux (plus communÃ©ment appelÃ©es â€œServeurs Discordâ€ par les Moldus) via leur identifiantÂ unique.</p>
<p>Ensuite, câ€™est le gros dawa, si vous invitez une guilde assez grosse, vous allez vous retrouver avec autant de notification dâ€™invitation Ã  accepter que de catÃ©gories ! Bon une fois que câ€™est validÃ©, vous Ãªtes tranquille, mais faite trÃ¨s attention aux journaux qui vont Ãªtre gÃ©nÃ©rÃ©s sur votre serveur, Ã§a va trÃ¨s rapidement remplir lâ€™espace disque sâ€™il y a de lâ€™activitÃ© sur vos canaux DiscordÂ !</p>
<ol>
<li>
<p>InviterÂ @discordbot</p>
</li>
<li>
<p>Sur lâ€™application mobile : <em>paramÃ¨tres de lâ€™app &gt; â€œScanner le <span class="caps">QR</span>Â codeâ€</em></p>
</li>
<li>
<p>Envoyer la commande au bot : <code>login-qr</code></p>
</li>
<li>
<p>La commande <code>guilds status</code> permet dâ€™afficher les diffÃ©rents â€œServeursÂ Discordâ€</p>
</li>
</ol>
<h2>WhatsApp</h2>
<p>Alors WhatsApp, pour faire simple, dispose dâ€™une sÃ©curitÃ© trÃ¨s dÃ©sagrÃ©able qui consiste Ã  dÃ©connecter tous vos accÃ¨s tiers aprÃ¨s une semaine, superÂ â€¦</p>
<p>Cela concerne donc Ã©galement votre Bridge quâ€™il vous faudra reconnecter avec un QRCode toute les semaines. Donc nous sommes bien forcÃ© de conserver lâ€™application officiel sur notre tel uniquement pour Ã§a â€¦ voila voila â€¦Â ğŸ‘Œ</p>
<ol>
<li>InviterÂ @whatsappbot</li>
<li>Sur lâ€™application mobile : <em>paramÃ¨tres de lâ€™app &gt; â€œScanner le <span class="caps">QR</span> <span class="caps">QR</span>â€</em></li>
<li>Envoyer la commande au bot : <code>login</code></li>
</ol>
<h2>Facebook etÂ Instagram</h2>
<p>Dans le mÃªme type de flood absurde que Discord, vous allez recevoir une notification dâ€™invitation Ã  accepter pour chaque personne â€¦ Jâ€™espÃ¨re pour vous que vous Ãªtes un asocial avec peu dâ€™amis sur ces plateformes, sinon vous aller user votre souris Ã  accepter des centaines dâ€™invitations une par une.
Un conseil, tester bien vos volumes docker, le redÃ©marrage du Bridge Ã  tendance Ã  tout remettre Ã  zÃ©ro, histoire de vous pousser au suicide une bonne fois pour toutesÂ ğŸ˜–</p>
<h2>Telegram</h2>
<p>Un peu plus long Ã  mettre en place, le bot Ã©tant encore en prototype au moment de mon test, mais ensuite, cela fonctionneÂ correctement.</p>
<p>Sur la configuration, il est nÃ©cessaire dâ€™ajouter une clef dâ€™<span class="caps">API</span> rÃ©cupÃ©rable sur :Â https://my.telegram.org/apps</p>
<div class="highlight"><pre><span></span><code>App api_id: 00000000
App api_hash: 00000000000000000000000000000000 
</code></pre></div>
<ol>
<li>InviterÂ @telegrambot</li>
<li>Sur lâ€™application mobile : <em>paramÃ¨tres de lâ€™app &gt; â€œScanner le code <span class="caps">QR</span>â€</em></li>
<li>Envoyer la commande au bot : <code>login-qr</code></li>
</ol>
<h2>WeChat</h2>
<p>La palme dâ€™or de la torture revient Ã  nos amis Chinois avec leur outilÂ abominable.</p>
<p>CrÃ©Ã© par un nerd Chinois rÃ©pondant au nom de <a href="https://github.com/duo/matrix-wechat-docker">lxduo</a>, ce dernier (probablement considÃ©rÃ© par un terroriste par le gouvernement chinois), a eu la patience de mettre au monde un Bridge capable de sâ€™accoupler avec cette horreur deÂ WeChat.</p>
<p>Ce qui donne naissance Ã  une terrible usine Ã  Gaz qui vous servira dâ€™hÃ´te, qui vous faudra accompagner dâ€™autant dâ€™usines Ã  gaz supplÃ©mentaire que vous souhaitez ajouter de compte WeChat â€¦ Le gros dÃ©lire en termes de consommation de ressourceÂ ğŸ˜­.</p>
<p>Bon dans mon cas <a href="https://github.com/duo/matrix-wechat-docker/issues/2">je nâ€™ai mÃªme pas rÃ©ussi Ã  le faire tomber en marche</a> et Ã  vrai dire, jâ€™ai sÃ»rement Ã©tÃ© banni de lâ€™outil par le gouvernement car impossible de me crÃ©er un compte, jâ€™ai donc renoncÃ©.
Je prÃ©vois un voyage en Chine en 2024, je vais en profiter pour me crÃ©er un compte en catimini avec un numÃ©ro sur place, je ferais peut-Ãªtre un article Ã  ce sujet un jour si câ€™estÂ croustillant.</p>
<ol>
<li>InviterÂ @wechatbot</li>
<li>Sur lâ€™application mobile : <em>paramÃ¨tres de lâ€™app &gt; â€œScanner le code <span class="caps">QR</span>â€</em></li>
<li>Envoyer la commande au bot : <code>login</code> pour tenter de dÃ©tecter lâ€™agentÂ WeChat</li>
</ol>
<h2><span class="caps">SMS</span></h2>
<p>En bonus, jâ€™ai tentÃ© lâ€™utilisation de <a href="https://f-droid.org/en/packages/eu.droogers.smsmatrix/">SmsMatrix</a>, une application Android qui peut fonctionner avec un Bridge, jâ€™ai fait fonctionner le machin ainsiÂ :</p>
<p>Sâ€™authentifier sur le compte <strong>@smsbot:matrix.domain.tld</strong> et inviter son compte utilisateur pour crÃ©er un canal de discussion.
AprÃ¨s autorisation, installer SmsMatrix sur votre tÃ©lÃ©phoneÂ :</p>
<div class="highlight"><pre><span></span><code><span class="n">Bot</span> <span class="n">Username</span> : <span class="n">smsbot</span>
<span class="n">Bot</span> <span class="n">Password</span> : **********
<span class="n">Homeserver</span> <span class="n">url</span> : <span class="n">https:</span>//<span class="n">matrix</span>.<span class="n">domain</span>.<span class="n">tld</span>
<span class="n">Your</span> <span class="n">username</span> @<span class="s">&lt;USER&gt;</span>:<span class="n">matrix</span>.<span class="n">com</span>
<span class="n">Devicename</span> : <span class="s">&lt;NOM-DU-TEL&gt;</span>
</code></pre></div>
<p>Il suffit ensuite de recevoir un <span class="caps">SMS</span> pour initialiser uneÂ conversation.</p>
<h1>ConclusionÂ ğŸ—’</h1>
<ul>
<li>
<p>Matrix, câ€™est le top du top de la messagerie. Tant sur lâ€™aspect techniqueÂ quâ€™Ã©thique.</p>
</li>
<li>
<p>Peu de personne connaissent et nâ€™utilisent Ã§a dans le monde pro et encore moinsÂ ailleurs.</p>
</li>
<li>
<p>La configuration dâ€™un serveur <span class="caps">TURN</span> supplÃ©mentaire est nÃ©cessaire si vous souhaitez profiter de laÂ VisioconfÃ©rence.</p>
</li>
<li>
<p>La configuration des Bridges est trÃ¨s chronophage etÂ instable.</p>
</li>
</ul>
<p>Câ€™est tout pour moi ğŸ˜‰ je vous relais maintenant les notes de mon ami <a href="https://www.linkedin.com/in/lucasassier">Lucas Assier</a>, qui souhaite Ã©galement partager son expÃ©rience avec Matrix.
Sans aller aussi loin que moi sur la quantitÃ© de Bridge testÃ©s, il a cependant abordÃ© le Double Puppetting, trÃ¨s intÃ©ressant pour profiter pleinement desÂ Bridges.</p>
<hr/>
<p>Lâ€™article ci-dessous, rÃ©digÃ© par <a href="https://www.linkedin.com/in/lucasassier">Lucas Assier</a>, date de SeptembreÂ 2023.</p>
<hr/>
<h1>PourquoiÂ Matrix</h1>
<p>Ã€ cela plusieurs raisons et cas dâ€™usagesÂ :</p>
<ul>
<li>
<p>En premier, les communications sont chiffrÃ©es, dans la mesure du possible, par design, ce qui permet de discuter avec des amis de sujets sensibles sans avoir Ã  se soucier de voir nos communications et piÃ¨ces jointes sur un <span class="caps">CDN</span> random (Nâ€™est-ce pas DiscordÂ ?).</p>
</li>
<li>
<p>En second, le systÃ¨me de fÃ©dÃ©ration : un utilisateur dâ€™un serveur peut communiquer sur un serveur diffÃ©rent de maniÃ¨re transparente. Jâ€™ai pu voir cela lâ€™an dernier sur lâ€™instance de visioconfÃ©rence de la Fosdem qui nâ€™est autre quâ€™une instance Matrix avec un pluginÂ jitsi</p>
</li>
<li>
<p>Le systÃ¨me de bridges : Le protocole de serveur Matrix a Ã©tÃ© pensÃ© pour inclure un systÃ¨me de â€œpasserellesâ€ permettant de lier un service quelconque a Matrix. Câ€™est notamment ce systÃ¨me qui mâ€™a poussÃ© Ã  passer le pas et Ã  dÃ©ployer ma propre instanceÂ Matrix.</p>
</li>
</ul>
<h1>Terminologie</h1>
<h2>Provider</h2>
<p>Matrix, câ€™est un peu comme le systÃ¨me de mails, il faut un fournisseur ou <strong>provider</strong> pour pouvoir communiquer. Pour cela, un <strong>homeserver</strong> va leur donner un compte, exempleÂ :</p>
<p><img alt="Matrix Exemple 1" class="img-fluid" src="../../assets/matrix_exemple_1.png"/></p>
<h2>Homeserver</h2>
<p>Un <strong>homeserver</strong> est un serveur Matrix (Synapse, Conduit, etcÂ â€¦).</p>
<p>Il est liÃ© a un seul domaine qui nâ€™est pas vouÃ© a changer.
Les comptes gÃ©nÃ©rÃ©s via les <strong>homeserver</strong> sont en deux parties comme suitÂ :</p>
<p><code>@user@homeserver.tld</code></p>
<p>Pour reprendre lâ€™exemple ci-dessus, cela donneraitÂ :</p>
<p><img alt="Matrix Exemple 2" class="img-fluid" src="../../assets/matrix_exemple_2.png"/></p>
<h2>AppService</h2>
<p>Câ€™est ce que lâ€™on peut comparer Ã  un bot standard.
Les AppServices doivent Ãªtre enregistrÃ©s dans la configuration du serveur, il nâ€™est pas possible de les enregistrer Ã  laÂ volÃ©e.</p>
<h2>Bridges</h2>
<p>Un bridge est un systÃ¨me permettant de connecter un groupement Matrix Ã  une autre plateforme, par exemple, Slack ou encoreÂ Signal.</p>
<p>Les bridges fonctionnent de deux maniÃ¨resÂ :</p>
<ol>
<li>
<p>Dans Matrix, les utilisateurs des autres plateformes sont vus en tant que â€œ<em>ghost</em>â€œ.</p>
</li>
<li>
<p>Dans lâ€™autre plateforme, les comptes utilisateurs de Matrix sont appelÃ©s des â€œ<em>puppets</em>â€œ.</p>
</li>
</ol>
<p>ExempleÂ :</p>
<p><img alt="Matrix Exemple 3" class="img-fluid" src="../../assets/matrix_exemple_3.png"/></p>
<p>Les spÃ©cifications Matrix sont complexe mais entiÃ¨rement documentÃ©es <a href="https://spec.matrix.org/latest/">ici</a>.</p>
<h1>Choisir sonÂ serveur</h1>
<p>Aujourdâ€™hui, Matrix possÃ¨de plusieurs implÃ©mentations serveurs plus ou moins aboutis.
Il y en a trois qui en ont retenu mon attentionÂ :</p>
<ol>
<li>
<p><strong>Synapse</strong> - la rÃ©fÃ©rence originale en python. Câ€™est le seul projet de serveur marquÃ© commeÂ stable.</p>
</li>
<li>
<p><strong>Conduit</strong> - une implÃ©mentation en <em><span class="caps">RUST</span></em> du protocole serveur de Matrix mais avec une empreinte mÃ©moire plusÂ faible.</p>
</li>
<li>
<p><strong>Dendrite</strong> - la mÃªme volontÃ© que Conduit, mais en <em><span class="caps">GO</span></em>. Certaines fonctions sont manquantes, la prioritÃ© Ã©tant lâ€™implÃ©mentation des fonctions pour les instances singleÂ user.</p>
</li>
</ol>
<h1>Monter sonÂ homeserver</h1>
<h2>PrÃ©parations</h2>
<p>Pour des raisons pratiques, nous allons assumer que le serveur retenu est Synapse (car officiel et implÃ©mente lâ€™intÃ©gralitÃ© des fonctionnalitÃ©s).
En premier lieu, il faut rÃ©flÃ©chir Ã  un nom de domaine, câ€™est trÃ¨s important car il est
impossible de le changer une fois le serveurÂ installÃ©.</p>
<p>Ensuite, il y a plusieurs maniÃ¨res dâ€™installer un serveur SynapseÂ :</p>
<ol>
<li>
<p>Via un packageÂ manager</p>
</li>
<li>
<p>ViaÂ Ansible</p>
</li>
<li>
<p>ViaÂ Docker</p>
</li>
</ol>
<p>Ici, nous verrons viaÂ Docker.</p>
<h2>La stack technique de laÂ dÃ©mo</h2>
<h3>UnÂ reverse-proxy</h3>
<p>Initialement, le projet est dÃ©ployÃ© dans une colocation de homelabs derriÃ¨re un seul et mÃªmeÂ port.</p>
<p>Par consÃ©quent, nous passons par Caddy afin de faire le routage enÂ reverse-proxy.</p>
<p>Cela, peut-Ãªtre contraignant, mais il est quand mÃªme nÃ©cessaire dâ€™en avoir un avec Synapse, notamment quand on va vouloir faire de laÂ dÃ©lÃ©gation.</p>
<h3>Une instanceÂ Docker</h3>
<p>Pour hÃ©berger le serveur ainsi que les bridges, le serveur et les bridges seront en deux stacks Docker-composeÂ sÃ©parÃ©s.</p>
<h2>DÃ©ployer le serveurÂ Synapse</h2>
<div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3'</span>
<span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">synapse</span><span class="p">:</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/matrixdotorg/synapse:latest</span>
<span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SYNAPSE_CONFIG_PATH=/data/homeserver.yaml</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse-data:/data</span>
<span class="w">        </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse-db</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8448:8448/tcp</span><span class="w"> </span><span class="c1"># Federation Traffic</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008:8008/tcp</span><span class="w"> </span><span class="c1"># Client Traffic</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridgenet</span>

<span class="w">    </span><span class="nt">synapse-db</span><span class="p">:</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse-pgsql</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/postgres:12-alpine</span>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=synapse</span>
<span class="err">Â Â Â Â Â Â Â Â Â Â Â Â </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=changeme!</span>
<span class="err">Â Â Â Â Â Â Â Â Â Â Â Â </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=synapse</span>
<span class="err">Â Â Â Â Â Â Â Â Â Â Â Â </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C</span>
<span class="err">Â Â Â Â Â Â Â Â </span><span class="nt">volumes</span><span class="p">:</span>
<span class="err">Â Â Â Â Â Â Â Â Â Â Â Â </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse-pgsql:/var/lib/postgresql/data</span>
<span class="err">Â Â Â Â Â Â Â Â </span><span class="nt">volumes</span><span class="p">:</span>
<span class="err">Â Â Â Â Â Â Â Â Â Â Â Â </span><span class="nt">synapse-data</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="err">Â Â Â Â Â Â Â Â Â Â Â Â </span><span class="nt">synapse-pgsql</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="err">Â Â Â Â Â Â Â Â </span><span class="nt">networks</span><span class="p">:</span>
<span class="err">Â Â Â Â Â Â Â Â Â Â Â Â </span><span class="nt">bridgenet</span><span class="p">:</span>
<span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse_bridges</span>
<span class="err">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<blockquote class="blockquote">
<p>Ã€ noter, nous avons un rÃ©seau Docker dÃ©diÃ© a lâ€™intercommunication entre Synapse et les Bridges installÃ©s comme suitÂ :</p>
<p><code>docker network create synapse_bridges</code></p>
</blockquote>
<p>En premier lieu, il faudra lancer Synapse pour lui dire de gÃ©nÃ©rer la configurationÂ :</p>
<p><code>docker-compose run --rm -e SYNAPSE_SERVER_NAME=matrix.kestrel.ovh -e
SYNAPSE_REPORT_STATS=no synapse generate</code></p>
<p>En suivant, il faudra Ã©diter la configuration <code>homeserver.yaml</code> dans le volumeÂ synapse-data. </p>
<p>Il sera important de regarder les options de configuration, notamment la configuration de la connexion Ã  la base Postgres, le nom du serveur (<em>server name</em>), que les serveurs de clÃ©s de confiance ainsi que lâ€™option pour autoriser la crÃ©ation de comptes ouÂ non. </p>
<p>Une fois cela fait, nous pouvons dÃ©marrer la stack via <code>docker compose up</code>. </p>
<blockquote class="blockquote">
<p>On pourrait faire en background mais comme nous en sommes Ã  la phase de lancement initiale, je prÃ©fÃ¨re laisser en premier plan afin de voir si lâ€™application lance des erreurs ouÂ non.</p>
</blockquote>
<h2>Configurer le reverse proxy et setup uneÂ dÃ©lÃ©gation</h2>
<p>Par dÃ©lÃ©gation, nous sous-entendons relayer le trafic Matrix a une entitÃ© dans un sous-domaine ouÂ ailleurs.</p>
<p>Ici, mon server name est <code>kestrel.ovh</code>, pour autant, le trafic est dÃ©lÃ©guÃ©s vers <code>matrix.kestrel.ovh</code> via la configuration suivanteÂ :</p>
<div class="highlight"><pre><span></span><code><span class="err">kes</span><span class="kc">trel</span><span class="err">.ovh</span><span class="w"> </span><span class="p">{</span>
<span class="err">Â Â Â Â Â Â Â header</span><span class="w"> </span><span class="err">/.well</span><span class="mi">-</span><span class="err">k</span><span class="kc">n</span><span class="err">ow</span><span class="kc">n</span><span class="err">/ma</span><span class="kc">tr</span><span class="err">ix/* Content-Type application/json</span>
<span class="err">Â Â Â Â Â Â Â header /.well-known/matrix/* Access-Control-Allow-Origin *</span>
<span class="err">Â Â Â Â Â Â Â respond /.well-known/matrix/server `{"m.server":</span>
<span class="err">"matrix.kestrel.ovh:443"}`</span>
<span class="err">Â Â Â Â Â Â Â respond /.well-known/matrix/client `{"m.homeserver":</span>
<span class="err">{"base_url":"https://matrix.kestrel.ovh"}}`</span>
<span class="err">}</span>
<span class="err">matrix.kestrel.ovh {</span>
<span class="err">Â Â Â Â Â Â Â reverse_proxy /_matrix/* 192.168.1.102:8008</span>
<span class="err">Â Â Â Â Â Â Â reverse_proxy /_synapse/client/* 192.168.1.102:8008</span>
<span class="err">}</span>
</code></pre></div>
<p>Il existe <a href="https://matrix-org.github.io/synapse/latest/reverse_proxy.html">une documentation</a> sur la configuration de divers reverse-proxy pour Matrix, avec ou sans dÃ©lÃ©gation.
Pour tester si la configuration est correcte, on peut utiliser <a href="https://federationtester.matrix.org">le testeur de fÃ©dÃ©ration</a> et voir si le trafic de fÃ©dÃ©ration est <span class="caps">OK</span>.</p>
<h2>CrÃ©er desÂ comptes</h2>
<p>Pour crÃ©er des comptes, il est possible de passer via une interface cliente Matrix tel que <a href="https://app.element.io/#/register">Element</a>.</p>
<p>Pour les serveurs qui nâ€™acceptent pas la crÃ©ation de comptes, il est possible de le faire via le conteneur Synapse via la commande suivanteÂ :</p>
<p><code>docker exec -it synapse register_new_matrix_user http://localhost:8008 -c
/data/homeserver.yaml</code></p>
<p>Synapse demandera quelques questions puis crÃ©era lesÂ comptes.</p>
<p>Personnellement, jâ€™ai optÃ© pour un compte admin dont je ne me sers uniquement pour lâ€™administration du serveur ainsi quâ€™un utilisateur standard pour mon usageÂ quotidien.</p>
<p>Ã€ ce stade, nous avons une instance Matrix fonctionnelle, avec un compte. Nous pouvons donc nous pencher sur lâ€™ajout de BridgesÂ !</p>
<h1>Ajouter unÂ Bridge</h1>
<blockquote class="blockquote">
<p>Le dÃ©ploiement dâ€™un Bridge peut Ãªtre long et fastidieux, par consÃ©quent, nous ne verrons que pour le BridgeÂ Mautrix-signald</p>
</blockquote>
<h2>Docker Compose 2: ElectricÂ Boogaloo</h2>
<div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">"3.7"</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mautrix-signal</span><span class="p">:</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-signal</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dock.mau.dev/mautrix/signal</span>
<span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-signal-data:/data</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-signal-signald:/signald</span>
<span class="w">        </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">signald</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridgenet</span><span class="w"> </span><span class="c1"># Communication w/ Synapse</span>

<span class="w">    </span><span class="nt">signald</span><span class="p">:</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">signald</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/signald/signald</span>
<span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-signal-signald:/signald</span>

<span class="w">    </span><span class="nt">mau-signal-db</span><span class="p">:</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mau-signal-db</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13-alpine</span>
<span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">            </span><span class="nt">POSTGRES_USER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrixsignal</span>
<span class="w">            </span><span class="nt">POSTGRES_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrixsignal</span>
<span class="w">            </span><span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">changeme!</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mautrix-signal-db:/var/lib/postgresql/data</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mautrix-signal-data</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">    </span><span class="nt">mautrix-signal-signald</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">    </span><span class="nt">mautrix-signal-db</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">    </span><span class="nt">bridgenet</span><span class="p">:</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse_bridges</span>
<span class="w">        </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
<p>Ici, pas Ã©normÃ©ment de choses Ã  dire, on lance la <span class="caps">DB</span>, puis signald (en vÃ©rifiant que cela ne crash pas). Ensuite, on lance le Bridge qui crÃ©e un fichier deÂ configuration.</p>
<p>Il faudra remplir le fichier avec les informations commeÂ :</p>
<ul>
<li>Lâ€™adresse du serveurÂ Synapse</li>
<li>Lâ€™adresse du conteneur du bridge (Pour que Synapse relaie nosÂ messages)</li>
<li>DÃ©sactiver leÂ manhole</li>
<li>RÃ©gler lesÂ permissions</li>
<li>Connecter la baseÂ postgres</li>
</ul>
<h2>Enregistrer une AppService dansÂ Synapse</h2>
<p>Une fois cela fait, on relance le conteneur. Si tout est correct, celui-ci va gÃ©nÃ©rer un fichier <code>appservice.yaml</code></p>
<p>Il faudra le copier dans le volume du conteneur synapse et le rÃ©fÃ©rencer comme suit dans la configuration <code>homeserver.yaml</code></p>
<div class="highlight"><pre><span></span><code><span class="c1"># NB: Il est pas necessaire de faire de sous-dossiers appservices mais c'est</span>
<span class="l l-Scalar l-Scalar-Plain">plus sympa.</span>
<span class="l l-Scalar l-Scalar-Plain">app_service_config_files</span><span class="p p-Indicator">:</span>
<span class="err">Â Â Â Â </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/appservices/mau-signal.yaml</span>
<span class="err">Â Â Â Â </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/appservices/mau-instagram.yaml</span>
<span class="err">Â Â Â Â </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/appservices/mau-slack.yaml</span>
</code></pre></div>
<p>Une fois ceci fait, relancer Synapse ainsi que le Bridge. Si tout fonctionne, le doit Ãªtre joignable via message privÃ© Ã  lâ€™adresse <strong>@signalbot:homeserver.tld</strong></p>
<h2>Se connecter Ã Â Signal</h2>
<p>Pour se connecter Ã  Signal, il faudra ouvrir un canal avec le bot, puis choisir une des deux options possiblesÂ :</p>
<p><code>**link**Â [device name] - Link the bridge as a secondary device</code>
<code>**register**Â &lt;phone&gt; - Sign into Signal as the primary device</code></p>
<p>Malheureusement, jâ€™ai eu une erreur quand jâ€™ai voulu â€œregisterâ€â€ donc je suis passÃ© via â€œlinkâ€, le bot fournit un <span class="caps">QR</span> Code permettant deÂ sâ€™authentifier.</p>
<p>Une fois lâ€™authentification effectuÃ©e, vous recevrez tout un tas dâ€™invitations de messages privÃ©s et deÂ canaux. </p>
<p>Ceux-ci sont gÃ©rÃ©s via le bot et font le lien avec toutes les conversations prÃ©sentes surÂ Signal.</p>
<p>Par exemple, ici, un canal avec des amisÂ :</p>
<p><img alt="Matrix Exemple 4" class="img-fluid" src="../../assets/matrix_exemple_4.png"/></p>
<blockquote class="blockquote">
<p>Ã€ noter, le bot est prÃ©sent dans chaque room afin de faire le lien. Il est possible de lui parler directement via <code>!signal</code> ou via <span class="caps">MP</span>.
En gris, tous les utilisateurs ayant le tag <code>(signal)</code> sont des â€œ<strong>ghosts</strong>â€ contrÃ´lÃ©s par leÂ bot.</p>
<p>Il est bon de noter aussi que nous ne sommes pas administrateur du canal mais que les admins du groupe Signal le sont par extension sur ce canalÂ Matrix.</p>
</blockquote>
<h2>Le DoubleÂ Puppetting</h2>
<p>Sur la capture dâ€™Ã©cran prÃ©cÃ©dente, nous avons pu voir que je possÃ¨de deux comptes, un compte Matrix et un compteÂ Signal.</p>
<p>On pourrait dire que lâ€™on sâ€™en fiche dans certains cas mais cela pose problÃ¨me lorsque les gens veulent meÂ mentionner. </p>
<p>Exemple iciÂ :</p>
<p><img alt="Matrix Exemple 5" class="img-fluid" src="../../assets/matrix_exemple_5.png"/></p>
<p>Ici on me mentionne pour un Ã©vÃ©nement. ProblÃ¨me, le Bridge mentionne mon compte Signal et non moi-mÃªme.
Pour palier Ã  cela, les dÃ©veloppeurs ont ajoutÃ© une fonction permettant de remplacer le compte de la plateforme en question (Ici, <em>Lucas(Signal)</em> ) par mon propre compteÂ Matrix.</p>
<p>Pour ce faire, il est possible de passer par deux maniÃ¨res de faireÂ :</p>
<ul>
<li>
<p>A la main via des â€œaccess tokens (Ã  coup de <code>curl</code> puis via des <span class="caps">MP</span> aux diffÃ©rents bots deÂ Bridge).</p>
</li>
<li>
<p>Automatiquement via <a href="https://github.com/devture/matrix-synapse-shared-secret-auth">ce plugin</a>. Pour des raisons Ã©videntes, nous allons passer par leÂ plugin.</p>
</li>
</ul>
<h3>Installer le module Shared SecretÂ Authenticator</h3>
<p>Pour installer le module, il faudra cloner depuis le dÃ©pÃ´t <span class="caps">GIT</span>, le fichier python, puis lâ€™ajouter aux volumes du conteneurÂ synapse.</p>
<p>Cloner le dÃ©pÃ´t : <code>git clone https://github.com/devture/matrix-synapse-shared-secret-auth</code></p>
<p>Puis lâ€™ajouter en tant que volumeÂ :</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">[</span><span class="nv">...</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse-data:/data</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/matrix-synapse-shared-secret-auth/shared_secret_authenticator.py:/usr/local/lib/python3.11/site-packages/shared_secret_authenticator.py</span>
</code></pre></div>
<p>GÃ©nÃ©rer un secret : <code>pwgen -s 128 1</code></p>
<p>Puis, dans le fichier <code>homeserver.yaml</code>, saisir les informations recensÃ©es dans le <span class="caps">GIT</span> croisÃ©es avec <a href="https://docs.mau.fi/bridges/general/double-puppeting.html">la documentation de Mautrix</a>.</p>
<div class="highlight"><pre><span></span><code><span class="nt">modules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shared_secret_authenticator.SharedSecretAuthProvider</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">config</span><span class="p p-Indicator">:</span>
<span class="w">            </span><span class="nt">shared_secret</span><span class="p">:</span><span class="w"> </span><span class="s">"YOUR_SHARED_SECRET_GOES_HERE"</span>
<span class="w">            </span><span class="nt">m_login_password_support_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">            </span><span class="nt">com_devture_shared_secret_auth_support_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<p>Une fois cela fait et le conteneur Synapse relancÃ©, dans la configuration du Bridge Signal, remplacerÂ :</p>
<div class="highlight"><pre><span></span><code><span class="nt">double_puppet_server_map</span><span class="p">:</span>
<span class="w">        </span><span class="nt">example.com</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://example.com</span>
<span class="w w-Error">    </span><span class="nt">login_shared_secret_map</span><span class="p">:</span>
<span class="w">        </span><span class="nt">example.com</span><span class="p">:</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">double_puppet_server_map</span><span class="p">:</span>
<span class="w">        </span><span class="nt">kestrel.ovh</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://synapse:8008</span>
<span class="w w-Error">    </span><span class="nt">login_shared_secret_map</span><span class="p">:</span>
<span class="w">        </span><span class="nt">kestrel.ovh</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">YOUR_SHARED_SECRET_GOES_HERE</span>
</code></pre></div>
<p>Ceci fait, relancer le conteneur Signal.
Si cela fonctionne correctement, le compte en trop doit disparaÃ®tre et les mentions envers ce compte sont maintenant redirigÃ©es vers lâ€™utilisateur MatrixÂ correct.</p>
<p><img alt="Matrix Exemple 6" class="img-fluid" src="../../assets/matrix_exemple_6.png"/></p>
    </div>
  </article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
    <li class="list-inline-item"><a href="https://heuzef.com/index.html"><i class="fa fa-home"></i> Accueil</a></li>
    <li class="list-inline-item"><a href="https://heuzef.com/categories.html"><i class="fa fa-cubes"></i> CatÃ©gories</a></li>
    <li class="list-inline-item"><a href="https://heuzef.com/tags.html"><i class="fa fa-tags"></i> Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    GÃ©nÃ©rÃ© avec <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
    / <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Licence Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
  </p>
</div>    </div>
  </footer>

</body>

</html>